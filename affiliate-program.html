<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Affiliate Program - Earn 30% Commission | Selira AI</title>
  <meta name="description" content="Join the Selira AI Affiliate Program and earn 30% commission on subscriptions and image packs. Promote AI companions and get rewarded.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://selira.ai/affiliate-program">
  <meta property="og:title" content="Affiliate Program - Selira AI">
  <meta property="og:description" content="Earn 30% commission promoting Selira AI. Join our affiliate program today!">
  <meta property="og:image" content="https://selira.ai/og-image.jpg">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://selira.ai/affiliate-program">
  <meta property="twitter:title" content="Affiliate Program | Selira AI">
  <meta property="twitter:description" content="Earn 30% commission promoting Selira AI companions and image generation.">
  <meta property="twitter:image" content="https://selira.ai/og-image.jpg">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XZXX201WKD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XZXX201WKD');
  </script>
  
  <!-- Auth0 Authentication System -->
  <!-- Supabase Authentication System -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-auth.js"></script>
  
  <!-- Selira AI Popup System -->
  <script src="/js/selira-popups.js"></script>
  
  <!-- Mobile Navigation System -->
  <script src="/js/mobile-nav.js"></script>
  
  <!-- Age Verification System -->
  <script src="/js/age-verification.js"></script>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      /* Selira dark theme - matching category.html */
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --bg-sidebar: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #888888;
      --accent: #ce93d8;
      --accent-hover: #ba68c8;
      --accent-secondary: #ec4899;
      --border: #333333;
      --border-color: #333333;
      --success: #10b981;
      --error: #ef4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Left Sidebar Navigation (Character.AI style) */
    .sidebar {
      width: 220px;
      background: var(--bg-sidebar);
      border-right: none;
      padding: 16px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 100;
      overflow-y: auto;
    }
    
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      text-decoration: none;
      color: inherit;
      transition: opacity 0.2s ease;
    }

    .sidebar-logo:hover {
      opacity: 0.8;
      text-decoration: none;
      color: inherit;
    }

    .sidebar-logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }

    .sidebar-nav {
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin-bottom: 2px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 13px;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-item-icon {
      font-size: 14px;
      width: 18px;
      height: 18px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .nav-item-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--accent);
    }

    .nav-section-title {
      font-size: 9px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 12px 0 4px;
      padding: 0 10px;
    }

    /* Sidebar Auth Buttons */
    .sidebar-auth-btn {
      display: block;
      width: 100%;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      text-align: center;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      margin-bottom: 8px;
    }

    .sidebar-auth-btn.secondary {
      background: transparent;
      color: var(--text-secondary);
      border-color: var(--border);
    }

    .sidebar-auth-btn.secondary:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .sidebar-auth-btn.primary {
      background: var(--accent);
      color: white;
    }

    .sidebar-auth-btn.primary:hover {
      background: var(--accent-hover, #c49563);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      margin-left: 220px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
    }
    
    /* Mobile Header (hidden on desktop) */
    .mobile-header {
      display: none;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .mobile-menu-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-sm);
      transition: background 0.2s ease;
    }
    
    .mobile-menu-btn:hover {
      background: var(--bg-tertiary);
    }
    
    .mobile-logo {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    
    /* Top Header (Character.AI style) */
    .top-header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 40;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 40px;
      gap: 24px;
    }
    
    /* Search */
    .search-container {
      position: relative;
      flex: 1;
      max-width: 600px;
    }
    
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .search-icon:hover {
      color: var(--accent);
    }
    
    .search-input {
      width: 100%;
      padding: 10px 16px 10px 48px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    
    .search-input:focus {
      border-color: var(--accent);
    }
    
    .search-input::placeholder {
      color: var(--text-muted);
    }
    
    /* User Actions */
    .user-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .dropdown-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
    }

    .dropdown-btn span {
      line-height: 1;
      display: inline;
    }

    .dropdown-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    .user-btn {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .user-btn.secondary {
      color: var(--text-secondary);
      border-color: var(--border);
    }
    
    .user-btn.secondary:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    .signup-btn {
      background: var(--accent);
      color: white;
    }
    
    .signup-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(206, 147, 216, 0.3);
    }
    
    /* Pricing Section */
    .pricing-section {
      padding: 16px 40px;
    }
    
    /* Tab Navigation */
    .pricing-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: 4px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 40px;
    }
    
    .tab-button {
      flex: 1;
      padding: 12px 24px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .tab-button.active {
      background: var(--accent);
      color: white;
    }
    
    .tab-button:hover:not(.active) {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Pricing Cards */
    .pricing-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
      margin-bottom: 40px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      padding: 0;
    }
    
    .pricing-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px 24px;
      position: relative;
      transition: all 0.3s ease;
      min-height: 500px;
      display: flex;
      flex-direction: column;
    }
    
    .pricing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }
    
    .pricing-card.featured {
      border-color: var(--accent);
      transform: scale(1.02);
    }
    
    .pricing-card.featured:hover {
      transform: scale(1.02) translateY(-4px);
    }

    .pricing-card.current-plan {
      border-color: #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-secondary) 100%);
    }

    .current-plan-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 12px;
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 2;
    }

    .card-badge {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 1;
    }

    /* Adjust badge positioning when both are present - stack vertically with more spacing */
    .pricing-card.featured.current-plan .card-badge {
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
    }

    .pricing-card.featured.current-plan .current-plan-badge {
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
    }
    
    .plan-name {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }
    
    .plan-price {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 8px;
    }
    
    .price-currency {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }
    
    .price-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .price-period {
      font-size: 16px;
      color: var(--text-secondary);
    }
    
    .price-daily {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 16px;
    }
    
    .plan-description {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 24px;
    }
    
    .plan-features {
      list-style: none;
      margin-bottom: 32px;
      flex-grow: 1;
    }
    
    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      color: var(--text-primary);
      font-size: 13px;
    }
    
    .feature-icon {
      color: var(--success);
      font-weight: 700;
      width: 16px;
    }
    
    .plan-button {
      width: 100%;
      padding: 14px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      text-align: center;
      display: block;
    }
    
    .plan-button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    .plan-button.secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .plan-button.secondary:hover {
      background: var(--bg-tertiary);
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .pricing-cards {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .pricing-section {
        padding: 24px 20px;
      }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 100;
        height: 60px;
        box-sizing: border-box;
      }

      .mobile-menu-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-primary);
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .mobile-logo {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
        flex-grow: 1;
        text-align: center;
        margin: 0 16px;
      }

      .top-header {
        display: none;
      }
      
      .header-top {
        padding: 16px 20px;
        flex-direction: column;
        gap: 16px;
      }
      
      .search-container {
        order: 2;
        max-width: none;
      }
      
      .user-actions {
        order: 1;
        justify-content: center;
        width: 100%;
      }
      
      .pricing-section {
        padding: 20px 16px;
      }
      
      .pricing-card {
        min-height: auto;
        padding: 24px 20px;
      }
      
      .pricing-card.featured {
        transform: scale(1);
      }
      
      .plan-name {
        font-size: 20px;
      }
      
      .price-amount {
        font-size: 28px;
      }
    }
    
    /* Sidebar Overlay for Mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }
    
    .sidebar-overlay.open {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pricing-section {
      animation: fadeIn 0.6s ease;
    }
    /* Sidebar Footer Links (Desktop only) */
    .sidebar-footer-links {
      margin-top: auto;
      padding: 16px 10px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .footer-link {
      color: rgba(255, 255, 255, 0.5);
      text-decoration: none;
      font-size: 11px;
      line-height: 1.4;
      transition: color 0.2s ease;
    }

    .footer-link:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Hide footer links on mobile */
    @media (max-width: 768px) {
      .sidebar-footer-links {
        display: none;
      }
    }

    /* Payment Icons (Desktop only) */
    .payment-icons {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
      padding: 0 10px;
      opacity: 0.7;
    }

    .payment-icon {
      height: 20px;
      width: auto;
      transition: opacity 0.2s ease;
    }

    .payment-icon:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .payment-icons {
        display: none;
      }
    }
  </style>

  <!-- Meta Pixel Code -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '1155600863117016');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=1155600863117016&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->

  <!-- Facebook Pixel Event Tracking -->
  <script src="/js/facebook-pixel-events.js"></script>
  <script src="/js/google-analytics-events.js"></script>

  <!-- FirstPromoter Tracking Script -->
  <script>(function(w){w.fpr=w.fpr||function(){w.fpr.q = w.fpr.q||[];w.fpr.q[arguments[0]=='set'?'unshift':'push'](arguments);};})(window);
  fpr("init", {cid:"20yp5m1k"}); fpr("click");
  </script>
  <script src="https://cdn.firstpromoter.com/fpr.js" async></script>
  <!-- End FirstPromoter Tracking Script -->

  <style>
    /* Remove current plan badge and featured styling for affiliate page */
    .pricing-card .card-badge,
    .pricing-card .current-plan-badge {
      display: none !important;
    }

    /* Line art icon styles */
    .icon-line {
      width: 40px;
      height: 40px;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
    }

    .icon-small {
      width: 32px;
      height: 32px;
    }

    /* Responsive styles for affiliate page */
    @media (max-width: 768px) {
      .pricing-section h1 {
        font-size: 28px !important;
      }

      .pricing-section > div > div:nth-child(2),
      .pricing-section > div > div:nth-child(3) {
        grid-template-columns: 1fr !important;
      }

      .pricing-section > div > div:nth-child(4) > div {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 8px 0 max(8px, env(safe-area-inset-bottom));
      z-index: 1000;
    }

    .mobile-bottom-nav-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 100%;
      margin: 0 auto;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      padding: 4px 8px;
      transition: all 0.2s ease;
      min-width: 60px;
      gap: 4px;
    }

    .mobile-nav-item svg {
      width: 22px;
      height: 22px;
      stroke-width: 2;
    }

    .mobile-nav-item:hover,
    .mobile-nav-item.active {
      color: var(--accent);
    }

    /* Standardize support widget size and position */
    .support-widget-btn {
      width: 36px !important;
      height: 36px !important;
      bottom: 20px !important;
      right: 20px !important;
    }

    .support-widget-btn svg {
      width: 16px !important;
      height: 16px !important;
    }

    @media (max-width: 768px) {
      .mobile-bottom-nav {
        display: block;
      }

      /* Add padding to main content to prevent overlap with bottom nav */
      .main-content {
        padding-bottom: 80px;
      }

      /* Position support widget above mobile bottom nav on mobile */
      .support-widget-btn {
        bottom: 80px !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Left Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <!-- Logo -->
      <a href="/" class="sidebar-logo">
        <div class="sidebar-logo-text">Selira AI</div>
      </a>

      <!-- Navigation -->
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span>
          <span>Discover</span>
        </a>
        <a href="/my-companions" class="nav-item">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
          <span>My Companions</span>
        </a>
        <a href="/create" class="nav-item">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></span>
          <span>Create</span>
        </a>
        <a href="/free-nsfw-image-generator" class="nav-item">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>
          <span>Image Generator</span>
        </a>

        <div class="nav-section-title">Account</div>

        <a href="/profile" class="nav-item" id="profileNavItem" style="display: none;">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>
          <span>Profile</span>
        </a>
        <a href="/pricing" class="nav-item">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>
          <span>Pricing</span>
        </a>
        <a href="/affiliate-program" class="nav-item active">
          <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
          <span>Affiliate Program</span>
        </a>


        <!-- CompanionGuide Rating (Mobile) -->
        <a href="https://companionguide.ai/companions/selira-ai" target="_blank" rel="noopener noreferrer" class="nav-item mobile-rating-link" style="font-size: 13px; padding: 10px 14px;">
          <span>CompanionGuide.ai 9.3/10 <span style="color: #FFD700; filter: brightness(1.2);">★★★★★</span></span>
        </a>

        <!-- Auth buttons for logged out users -->
        <div id="sidebarAuthButtons" style="display: none; flex-direction: column;">
          <a href="#" class="nav-item" onclick="openLoginModal('login', event); return false;">
            <span class="nav-item-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></span>
            <span>Login</span>
          </a>
          <a href="#" class="sidebar-auth-btn primary" onclick="openLoginModal('signup', event); return false;" style="margin: 8px 10px 0; width: calc(100% - 20px);">Register</a>
        </div>

      </nav>
          <!-- Footer Links (Desktop only) -->
      <div class="sidebar-footer-links">
        <a href="/contact" class="footer-link">Contact</a>
        <a href="/privacy-policy" class="footer-link">Privacy Policy</a>
        <a href="/terms-and-conditions" class="footer-link">Terms & Conditions</a>
        <a href="https://companionguide.ai/companions/selira-ai" target="_blank" rel="noopener noreferrer" class="footer-link">CompanionGuide.ai 9.3/10 <span style="color: #FFD700; filter: brightness(1.2);">★★★★★</span></a>
      </div>

      <!-- Payment Icons -->
      <div class="payment-icons">
        <!-- PayPal -->
        <svg class="payment-icon" viewBox="0 0 124 33" xmlns="http://www.w3.org/2000/svg">
          <path fill="#253B80" d="M46.211 6.749h-6.839a.95.95 0 0 0-.939.802l-2.766 17.537a.57.57 0 0 0 .564.658h3.265a.95.95 0 0 0 .939-.803l.746-4.73a.95.95 0 0 1 .938-.803h2.165c4.505 0 7.105-2.18 7.784-6.5.306-1.89.013-3.375-.872-4.415-.972-1.142-2.696-1.746-4.985-1.746zM47 13.154c-.374 2.454-2.249 2.454-4.062 2.454h-1.032l.724-4.583a.57.57 0 0 1 .563-.481h.473c1.235 0 2.4 0 3.002.704.359.42.469 1.044.332 1.906zM66.654 13.075h-3.275a.57.57 0 0 0-.563.481l-.145.916-.229-.332c-.709-1.029-2.29-1.373-3.868-1.373-3.619 0-6.71 2.741-7.312 6.586-.313 1.918.132 3.752 1.22 5.031.998 1.176 2.426 1.666 4.125 1.666 2.916 0 4.533-1.875 4.533-1.875l-.146.91a.57.57 0 0 0 .562.66h2.95a.95.95 0 0 0 .939-.803l1.77-11.209a.568.568 0 0 0-.561-.658zm-4.565 6.374c-.316 1.871-1.801 3.127-3.695 3.127-.951 0-1.711-.305-2.199-.883-.484-.574-.668-1.391-.514-2.301.295-1.855 1.805-3.152 3.67-3.152.93 0 1.686.309 2.184.892.499.589.697 1.411.554 2.317zM84.096 13.075h-3.291a.954.954 0 0 0-.787.417l-4.539 6.686-1.924-6.425a.953.953 0 0 0-.912-.678h-3.234a.57.57 0 0 0-.541.754l3.625 10.638-3.408 4.811a.57.57 0 0 0 .465.9h3.287a.949.949 0 0 0 .781-.408l10.946-15.8a.57.57 0 0 0-.468-.895z"/>
          <path fill="#179BD7" d="M94.992 6.749h-6.84a.95.95 0 0 0-.938.802l-2.766 17.537a.569.569 0 0 0 .562.658h3.51a.665.665 0 0 0 .656-.562l.785-4.971a.95.95 0 0 1 .938-.803h2.164c4.506 0 7.105-2.18 7.785-6.5.307-1.89.012-3.375-.873-4.415-.971-1.142-2.694-1.746-4.983-1.746zm.789 6.405c-.373 2.454-2.248 2.454-4.062 2.454h-1.031l.725-4.583a.568.568 0 0 1 .562-.481h.473c1.234 0 2.4 0 3.002.704.359.42.468 1.044.331 1.906zM115.434 13.075h-3.273a.567.567 0 0 0-.562.481l-.145.916-.23-.332c-.709-1.029-2.289-1.373-3.867-1.373-3.619 0-6.709 2.741-7.311 6.586-.312 1.918.131 3.752 1.219 5.031 1 1.176 2.426 1.666 4.125 1.666 2.916 0 4.533-1.875 4.533-1.875l-.146.91a.57.57 0 0 0 .564.66h2.949a.95.95 0 0 0 .938-.803l1.771-11.209a.571.571 0 0 0-.565-.658zm-4.565 6.374c-.314 1.871-1.801 3.127-3.695 3.127-.949 0-1.711-.305-2.199-.883-.484-.574-.666-1.391-.514-2.301.297-1.855 1.805-3.152 3.67-3.152.93 0 1.686.309 2.184.892.501.589.699 1.411.554 2.317zM119.295 7.23l-2.807 17.858a.569.569 0 0 0 .562.658h2.822c.469 0 .867-.34.938-.803l2.768-17.536a.57.57 0 0 0-.562-.659h-3.16a.571.571 0 0 0-.561.482z"/>
          <path fill="#253B80" d="M7.266 29.154l.523-3.322-1.165-.027H1.061L4.927 1.292a.316.316 0 0 1 .314-.268h9.38c3.114 0 5.263.648 6.385 1.927.526.6.861 1.227 1.023 1.917.17.724.173 1.589.007 2.644l-.012.077v.676l.526.298a3.69 3.69 0 0 1 1.065.812c.45.513.741 1.165.864 1.938.127.795.085 1.741-.123 2.812-.24 1.232-.628 2.305-1.152 3.183a6.547 6.547 0 0 1-1.825 2c-.696.494-1.523.869-2.458 1.109-.906.236-1.939.355-3.072.355h-.73c-.522 0-1.029.188-1.427.525a2.21 2.21 0 0 0-.744 1.328l-.055.299-.924 5.855-.042.215c-.011.068-.03.102-.058.125a.155.155 0 0 1-.096.035H7.266z"/>
          <path fill="#179BD7" d="M23.048 7.667c-.028.179-.06.362-.096.55-1.237 6.351-5.469 8.545-10.874 8.545H9.326c-.661 0-1.218.48-1.321 1.132L6.596 26.83l-.399 2.533a.704.704 0 0 0 .695.814h4.881c.578 0 1.069-.42 1.16-.99l.048-.248.919-5.832.059-.32c.09-.572.582-.992 1.16-.992h.73c4.729 0 8.431-1.92 9.513-7.476.452-2.321.218-4.259-.978-5.622a4.667 4.667 0 0 0-1.336-1.03z"/>
          <path fill="#222D65" d="M21.754 7.151a9.757 9.757 0 0 0-1.203-.267 15.284 15.284 0 0 0-2.426-.177h-7.352a1.172 1.172 0 0 0-1.159.992L8.05 17.605l-.045.289a1.336 1.336 0 0 1 1.321-1.132h2.752c5.405 0 9.637-2.195 10.874-8.545.037-.188.068-.371.096-.55a6.594 6.594 0 0 0-1.017-.429 9.045 9.045 0 0 0-.277-.087z"/>
          <path fill="#253B80" d="M9.614 7.699a1.169 1.169 0 0 1 1.159-.991h7.352c.871 0 1.684.057 2.426.177a9.757 9.757 0 0 1 1.481.353c.365.121.704.264 1.017.429.368-2.347-.003-3.945-1.272-5.392C20.378.682 17.853 0 14.622 0h-9.38c-.66 0-1.223.48-1.325 1.133L.01 25.898a.806.806 0 0 0 .795.932h5.791l1.454-9.225 1.564-9.906z"/>
        </svg>

        <!-- Mastercard -->
        <svg class="payment-icon" viewBox="0 0 48 30" xmlns="http://www.w3.org/2000/svg">
          <rect width="48" height="30" rx="3" fill="#000"/>
          <circle cx="18" cy="15" r="10" fill="#EB001B"/>
          <circle cx="30" cy="15" r="10" fill="#F79E1B"/>
          <path fill="#FF5F00" d="M24 7.5c-2.088 1.623-3.43 4.149-3.43 7s1.342 5.377 3.43 7c2.088-1.623 3.43-4.149 3.43-7s-1.342-5.377-3.43-7z"/>
        </svg>

        <!-- Apple Pay -->
        <img src="/images/apple-pay-selira-ai.svg" alt="Apple Pay" class="payment-icon">

        <!-- Bitcoin -->
        <img src="/images/bitcoin-selira-ai.webp" alt="Bitcoin" class="payment-icon">
      </div>
    </aside>
      

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Mobile Header -->
      <div class="mobile-header">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
        <div class="mobile-logo">Selira AI</div>
      </div>

      <!-- Top Header -->
      <header class="top-header">
        <div class="header-top">
          <!-- Search -->
          <div class="search-container">
            <div class="search-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
            <input 
              type="text" 
              class="search-input" 
              placeholder="blonde"
              id="searchInput"
            >
          </div>

          <!-- User Actions -->
          <div class="user-actions">
            <select class="dropdown-btn" style="border: none; background: none; color: white; font-size: 13px;">
              <option>English</option>
            </select>
            <a href="#" class="user-btn secondary login-btn" onclick="openLoginModal('login'); return false;">Login</a>
            <a href="#" class="user-btn signup-btn" onclick="openLoginModal('signup'); return false;">Register</a>
          </div>
        </div>
      </header>

      <!-- Affiliate Program Section -->
      <section class="pricing-section">

          <!-- Hero Section -->
          <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; letter-spacing: -0.02em;">
              Affiliate Program
            </h1>
            <p style="font-size: 16px; color: var(--text-secondary); max-width: 600px; margin: 0 auto 20px;">
              Partner with Selira and earn <span style="color: var(--accent); font-weight: 600;">30% commission</span> on every sale
            </p>

            <!-- CTA Button -->
            <div style="text-align: center;">
              <a href="https://selira.firstpromoter.com" target="_blank" rel="noopener"
                 style="display: inline-block; padding: 14px 40px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; text-decoration: none; border-radius: var(--radius-md); font-weight: 600; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(206, 147, 216, 0.3);"
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(206, 147, 216, 0.4)';"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(206, 147, 216, 0.3)';">
                Join Affiliate Program →
              </a>
            </div>
          </div>

          <!-- Commission Cards Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px;">

            <!-- Subscription Commission -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; position: relative; overflow: hidden;">
              <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: var(--accent); opacity: 0.1; border-radius: 50%;"></div>
              <div style="margin-bottom: 12px;">
                <svg class="icon-line" style="color: var(--accent);" viewBox="0 0 24 24">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
              </div>
              <div style="font-size: 28px; font-weight: 700; color: var(--accent); margin-bottom: 8px;">30%</div>
              <div style="font-size: 14px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">Recurring Commission</div>
              <div style="font-size: 13px; color: var(--text-secondary);">On all subscription plans</div>
            </div>

            <!-- One-off Commission -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; position: relative; overflow: hidden;">
              <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: var(--accent-secondary); opacity: 0.1; border-radius: 50%;"></div>
              <div style="margin-bottom: 12px;">
                <svg class="icon-line" style="color: var(--accent-secondary);" viewBox="0 0 24 24">
                  <path d="M6 3h12l4 6-10 13L2 9l4-6zM12 17l-4-7h8l-4 7z"/>
                </svg>
              </div>
              <div style="font-size: 28px; font-weight: 700; color: var(--accent-secondary); margin-bottom: 8px;">30%</div>
              <div style="font-size: 14px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">First Charge</div>
              <div style="font-size: 13px; color: var(--text-secondary);">On one-off image packs</div>
            </div>

          </div>

          <!-- Features Grid -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">

            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center;">
              <div style="margin-bottom: 8px; display: flex; justify-content: center;">
                <svg class="icon-line icon-small" style="color: var(--accent);" viewBox="0 0 24 24">
                  <path d="M3 3v18h18M7 16l4-4 4 4 6-6"/>
                </svg>
              </div>
              <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">Real-time Analytics</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Track performance</div>
            </div>

            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center;">
              <div style="margin-bottom: 8px; display: flex; justify-content: center;">
                <svg class="icon-line icon-small" style="color: var(--accent);" viewBox="0 0 24 24">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                  <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
              </div>
              <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">Monthly Payouts</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Your preferred method</div>
            </div>

            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center;">
              <div style="margin-bottom: 8px; display: flex; justify-content: center;">
                <svg class="icon-line icon-small" style="color: var(--accent);" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">Marketing Support</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Materials provided</div>
            </div>

          </div>
      </section>
    </main>
  </div>

  <script>
    // Mobile sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    // Initialize search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
          if (e.key === 'Enter' && this.value.trim()) {
            window.location.href = `/search-results?q=${encodeURIComponent(this.value.trim())}`;
          }
        });

        // Also add click listener to search icon
        const searchIcon = document.querySelector('.search-icon');
        if (searchIcon) {
          searchIcon.addEventListener('click', function() {
            const query = searchInput.value.trim();
            if (query) {
              window.location.href = `/search-results?q=${encodeURIComponent(query)}`;
            }
          });
        }
      }
    });
    
    // Close sidebar when clicking overlay
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
      toggleSidebar();
    });
    
    // Navigation functions for consistency with /category
    function showMyCompanions() {
      window.location.href = '/category';
    }
    
    function showCreateCharacter() {
      window.location.href = '/create';
    }
    
    // Tab switching functionality
    function switchTab(tabName) {
      // Remove active class from all tabs and tab buttons
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });

      // Add active class to selected tab
      document.getElementById(tabName + '-tab').classList.add('active');

      // Add active class to corresponding button
      const buttonIndex = tabName === 'subscriptions' ? 0 : 1;
      document.querySelectorAll('.tab-button')[buttonIndex].classList.add('active');
    }
    
    // Handle plan button clicks
    function handlePlanClick(planType) {
      console.log('🚀 handlePlanClick called with planType:', planType);

      // PRIORITY CHECK: Premium -> Basic/Light downgrade
      if (planType === 'basic' || planType === 'light') {
        // Check if user is currently on Premium
        const premiumCard = document.querySelector('.pricing-card:nth-child(4)');
        const targetButton = document.querySelector(`.pricing-card:nth-child(${planType === 'light' ? '2' : '3'}) .plan-button`);

        console.log(`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Checking for Premium -> ${planType.charAt(0).toUpperCase() + planType.slice(1)} downgrade:`, {
          premiumCardExists: !!premiumCard,
          premiumHasCurrentPlan: premiumCard ? premiumCard.classList.contains('current-plan') : false,
          targetButtonExists: !!targetButton,
          targetButtonText: targetButton ? targetButton.textContent : 'N/A'
        });

        if (premiumCard && premiumCard.classList.contains('current-plan')) {
          console.log(`🎯 PREMIUM -> ${planType.toUpperCase()} DOWNGRADE DETECTED (current-plan class) - bypassing normal flow`);
          downgradePlan(planType);
          return;
        }

        if (targetButton && targetButton.textContent.includes(`Downgrade to ${planType.charAt(0).toUpperCase() + planType.slice(1)}`)) {
          console.log(`🎯 PREMIUM -> ${planType.toUpperCase()} DOWNGRADE DETECTED (button text) - bypassing normal flow`);
          downgradePlan(planType);
          return;
        }
      }

      // Check if user is logged in
      const isLoggedIn = localStorage.getItem('auth0_token') || localStorage.getItem('user_uid');

      if (!isLoggedIn) {
        // User is not logged in - show registration popup
        if (typeof openLoginModal === 'function') {
          openLoginModal('signup');
        } else {
          // Fallback if auth0-login.js is not loaded
          alert('Please sign up to choose a plan');
        }
        return;
      }

      // User is logged in - handle based on plan type
      if (planType === 'free') {
        // Free plan - check if it's a downgrade
        // First check if we have current plan info, if not, try to load it
        if (window.currentUserPlan === undefined) {
          // Plan not loaded yet - load it first then handle the click
          loadCurrentPlan().then(() => {
            // After loading, check again
            if (window.currentUserPlan && window.currentUserPlan !== 'free') {
              downgradeToFree();
            } else {
              // Already free or couldn't determine plan - redirect to category page
              window.location.href = '/category';
            }
          }).catch(() => {
            // If loading fails, assume they want to downgrade and show the process
            downgradeToFree();
          });
        } else if (window.currentUserPlan && window.currentUserPlan !== 'free') {
          downgradeToFree();
        } else {
          // Already free or new user - redirect to category page
          window.location.href = '/category';
        }
      } else {
        // Paid plans - check if this is an upgrade or downgrade
        handlePaidPlanSelection(planType);
      }
    }

    // Handle paid plan selection (upgrade or downgrade)
    async function handlePaidPlanSelection(planType) {
      try {
        console.log('🔄 Starting plan selection for:', planType);
        console.log('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Current window.currentUserPlan:', window.currentUserPlan);

        // Try to determine current plan from button text as fallback
        let detectedCurrentPlan = 'free';

        // Check if any pricing card has "current plan" styling
        const currentPlanCard = document.querySelector('.pricing-card.current-plan');
        if (currentPlanCard) {
          const planName = currentPlanCard.querySelector('.plan-name');
          if (planName) {
            detectedCurrentPlan = planName.textContent.toLowerCase();
            console.log('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Detected current plan from UI:', detectedCurrentPlan);
          }
        }

        // Also check button texts for downgrade clues
        const lightButton = document.querySelector('.pricing-card:nth-child(2) .plan-button');
        const basicButton = document.querySelector('.pricing-card:nth-child(3) .plan-button');
        const premiumButton = document.querySelector('.pricing-card:nth-child(4) .plan-button');

        if (lightButton && lightButton.textContent.includes('Downgrade to Light')) {
          detectedCurrentPlan = 'basic';  // or premium
          console.log('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Detected basic/premium plan from Light downgrade button');
        } else if (basicButton && basicButton.textContent.includes('Downgrade to Basic')) {
          detectedCurrentPlan = 'premium';
          console.log('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Detected premium plan from Basic downgrade button');
        }

        // Always load current plan to get the most up-to-date info
        console.log('🔄 Loading current plan...');
        await loadCurrentPlan();

        // Use the loaded plan, fallback to detected plan
        const currentPlan = window.currentUserPlan || detectedCurrentPlan;
        const planHierarchy = { 'free': 0, 'light': 1, 'basic': 2, 'premium': 3 };

        console.log('🔄 Plan comparison:', {
          currentPlan,
          detectedCurrentPlan,
          targetPlan: planType,
          currentLevel: planHierarchy[currentPlan],
          targetLevel: planHierarchy[planType],
          isUpgrade: planHierarchy[planType] > planHierarchy[currentPlan],
          isDowngrade: planHierarchy[planType] < planHierarchy[currentPlan],
          isSame: planHierarchy[planType] === planHierarchy[currentPlan]
        });

        // For Premium -> Basic specifically, force downgrade logic
        if (currentPlan === 'premium' && planType === 'basic') {
          console.log('🎯 FORCED DOWNGRADE: Premium -> Basic detected');
          await downgradePlan(planType);
          return;
        }

        // Determine if this is an upgrade or downgrade
        if (planHierarchy[planType] > planHierarchy[currentPlan]) {
          // This is an upgrade - use Stripe checkout
          console.log('✅ Upgrade detected - using Stripe checkout');
          initiateStripeCheckout(planType);
        } else if (planHierarchy[planType] < planHierarchy[currentPlan]) {
          // This is a downgrade - use subscription downgrade
          console.log('✅ Downgrade detected - using subscription update');
          await downgradePlan(planType);
        } else {
          // Same plan - shouldn't happen but handle gracefully
          console.log('⚠️ Same plan selected');
          alert('You are already on this plan');
        }

      } catch (error) {
        console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Error handling plan selection:', error);
        // Fallback to Stripe checkout if we can't determine current plan
        console.log('🔄 Falling back to Stripe checkout due to error');
        initiateStripeCheckout(planType);
      }
    }

    // Downgrade to a paid plan (Premium -> Basic)
    async function downgradePlan(targetPlan) {
      const confirmMessage = `Are you sure you want to downgrade to the ${targetPlan.charAt(0).toUpperCase() + targetPlan.slice(1)} plan?\n\nYour subscription will be updated immediately and you can continue using your current plan benefits until your next billing date.`;

      if (!confirm(confirmMessage)) {
        return;
      }

      // Delay to ensure confirm dialog is fully closed before showing success message
      const showSuccessMessage = (message) => {
        setTimeout(() => {
          alert(message);
        }, 500);
      };

      try {
        const user = window.getCurrentUser();
        if (!user) {
          showSuccessMessage('Please log in to manage your subscription');
          return;
        }

        console.log('🔄 Downgrading to', targetPlan, 'for user:', user.email);

        // Show loading state on the target plan button
        const cardIndex = targetPlan === 'light' ? '2' : targetPlan === 'basic' ? '3' : '4';
        const targetCard = document.querySelector(`.pricing-card:nth-child(${cardIndex})`);
        const targetButton = targetCard ? targetCard.querySelector('.plan-button') : null;
        if (targetButton) {
          const originalText = targetButton.textContent;
          targetButton.textContent = 'Processing...';
          targetButton.style.opacity = '0.7';
        }

        // Call the manage subscription function with downgrade action
        const requestData = {
          action: 'downgrade_plan',
          targetPlan: targetPlan,
          userEmail: user.email,
          auth0Id: user.sub
        };

        console.log('🔄 Sending downgrade request:', requestData);

        const response = await fetch('/.netlify/functions/selira-manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        console.log('📊 Response status:', response.status);

        let result;
        try {
          result = await response.json();
        } catch (jsonError) {
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Failed to parse response as JSON:', jsonError);
          const textResponse = await response.text();
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Raw response:', textResponse);
          showSuccessMessage(`Server error: Unable to parse response. Status: ${response.status}`);
          return;
        }

        console.log('📋 Parsed result:', result);

        if (response.ok && result.success) {
          console.log('✅ Plan downgrade successful:', result);

          let successMessage = `Plan downgraded to ${targetPlan.charAt(0).toUpperCase() + targetPlan.slice(1)} successfully!`;

          if (result.next_billing_date) {
            successMessage += `\n\nYou can continue to use your current plan benefits until ${result.next_billing_date}`;
          }

          showSuccessMessage(successMessage);

          // Reload the current plan display
          await loadCurrentPlan();

        } else {
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Downgrade failed:', result);
          let alertMessage = `Failed to downgrade plan: ${result.error || 'Unknown error'}`;

          if (result.details) {
            alertMessage += `\n\nDetails: ${result.details}`;
          }

          showSuccessMessage(alertMessage);
        }

        // Restore button state
        if (targetButton) {
          targetButton.textContent = `Downgrade to ${targetPlan.charAt(0).toUpperCase() + targetPlan.slice(1)}`;
          targetButton.style.opacity = '1';
        }

      } catch (error) {
        console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Error downgrading plan:', error);
        showSuccessMessage('An error occurred while downgrading your plan. Please try again.');

        // Restore button state
        const cardIndex = targetPlan === 'light' ? '2' : targetPlan === 'basic' ? '3' : '4';
        const targetCard = document.querySelector(`.pricing-card:nth-child(${cardIndex})`);
        const targetButton = targetCard ? targetCard.querySelector('.plan-button') : null;
        if (targetButton) {
          targetButton.textContent = `Downgrade to ${targetPlan.charAt(0).toUpperCase() + targetPlan.slice(1)}`;
          targetButton.style.opacity = '1';
        }
      }
    }

    // Initiate Stripe checkout for paid plans
    async function initiateStripeCheckout(planType) {
      try {
        // Map plan types to Stripe price IDs
        const priceIds = {
          'light': 'price_1SEuikDEKVIZZyJVq7p80aW7',
          'basic': 'price_1S9KVADEKVIZZyJVXXjE2gYE',
          'premium': 'price_1S9KVbDEKVIZZyJVDpWlXYhb'
        };

        const priceId = priceIds[planType];
        if (!priceId) {
          console.error('Invalid plan type:', planType);
          alert('Invalid plan selected');
          return;
        }

        // Get user info
        const userEmail = localStorage.getItem('user_email');
        const userId = localStorage.getItem('user_uid');

        if (!userEmail || !userId) {
          console.error('Missing user information');
          alert('Please log in again to continue');
          window.location.href = '/';
          return;
        }

        // Create Stripe checkout session
        const response = await fetch('/.netlify/functions/selira-create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            priceId: priceId,
            userEmail: userEmail,
            userId: userId,
            planName: planType,
            successUrl: window.location.origin + '/profile?payment=success',
            cancelUrl: window.location.origin + '/pricing'
          })
        });

        if (!response.ok) {
          const error = await response.json();
          console.error('Checkout session error:', error);
          alert('Unable to start checkout process. Please try again.');
          return;
        }

        const { sessionUrl } = await response.json();

        if (sessionUrl) {
          // Redirect to Stripe checkout
          window.location.href = sessionUrl;
        } else {
          console.error('No session URL received');
          alert('Unable to start checkout process. Please try again.');
        }

      } catch (error) {
        console.error('Error initiating checkout:', error);
        alert('An error occurred. Please try again later.');
      }
    }

    // Downgrade to free plan
    async function downgradeToFree() {
      const confirmMessage = 'Are you sure you want to downgrade to the Free plan?\n\nYour current subscription will be canceled at the end of your current billing period, and you will keep access until then.';

      if (!confirm(confirmMessage)) {
        return;
      }

      // Delay to ensure confirm dialog is fully closed before showing success message
      const showSuccessMessage = (message) => {
        setTimeout(() => {
          alert(message);
        }, 500); // Increased delay to prevent overlap
      };

      try {
        const user = window.getCurrentUser();
        if (!user) {
          showSuccessMessage('Please log in to manage your subscription');
          return;
        }

        console.log('🔄 Downgrading to free plan for user:', user.email);

        // Show loading state
        const freeButton = document.querySelector('.pricing-card:nth-child(1) .plan-button');
        if (freeButton) {
          const originalText = freeButton.textContent;
          freeButton.textContent = 'Processing...';
          freeButton.style.opacity = '0.7';
        }

        // Call the manage subscription function with cancel_at_period_end action
        const requestData = {
          action: 'cancel_at_period_end',
          userEmail: user.email,
          auth0Id: user.sub
        };

        console.log('🔄 Sending downgrade request:', requestData);

        const response = await fetch('/.netlify/functions/selira-manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        console.log('📊 Response status:', response.status);
        console.log('📊 Response ok:', response.ok);

        let result;
        try {
          result = await response.json();
        } catch (jsonError) {
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Failed to parse response as JSON:', jsonError);
          const textResponse = await response.text();
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Raw response:', textResponse);
          showSuccessMessage(`Server error: Unable to parse response. Status: ${response.status}`);
          return;
        }

        console.log('📋 Parsed result:', result);

        if (response.ok && result.success) {
          console.log('✅ Subscription downgrade successful:', result);

          // Use delayed success message
          showSuccessMessage(`Subscription canceled successfully!\n\nYou will keep access to your current plan until ${result.cancels_at || 'the end of your billing period'}, after which you will be automatically switched to the Free plan.`);

          // Reload the current plan display
          await loadCurrentPlan();

        } else {
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Downgrade failed:', result);
          let alertMessage = `Failed to downgrade subscription: ${result.error || 'Unknown error'}\n\nDetails: ${result.details || 'No additional details'}`;

          if (result.debugInfo) {
            console.log('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Debug info:', result.debugInfo);
            alertMessage += `\n\nDebug Info:\nUser Plan: ${result.debugInfo.userPlan || 'Unknown'}\nAvailable Fields: ${result.debugInfo.availableFields ? result.debugInfo.availableFields.join(', ') : 'None'}\nStripe Fields: ${result.debugInfo.stripeFields ? result.debugInfo.stripeFields.join(', ') : 'None'}`;
          }

          showSuccessMessage(alertMessage);
        }

        // Restore button state
        if (freeButton) {
          freeButton.textContent = 'Downgrade to Free';
          freeButton.style.opacity = '1';
        }

      } catch (error) {
        console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Error downgrading subscription:', error);
        showSuccessMessage('An error occurred while downgrading your subscription. Please try again.');

        // Restore button state
        const freeButton = document.querySelector('.pricing-card:nth-child(1) .plan-button');
        if (freeButton) {
          freeButton.textContent = 'Downgrade to Free';
          freeButton.style.opacity = '1';
        }
      }
    }

    // Load current subscription info
    async function loadCurrentPlan() {
      try {
        // Check if user is authenticated using the existing window functions
        if (!window.isUserAuthenticated || !window.isUserAuthenticated()) {
          console.log('🔄 User not authenticated, setting plan to free');
          window.currentUserPlan = 'free';
          return;
        }

        const user = window.getCurrentUser();
        if (!user) {
          console.log('🔄 No user data available, setting plan to free');
          window.currentUserPlan = 'free';
          return;
        }

        console.log('🔄 Loading current plan for user:', user.email);

        const response = await fetch(`/.netlify/functions/selira-get-subscription-info?email=${encodeURIComponent(user.email)}&auth0_id=${encodeURIComponent(user.sub)}`);
        const data = await response.json();

        if (data.success && data.subscription) {
          console.log('✅ Current plan loaded:', data.subscription.plan);
          updatePricingDisplay(data.subscription);
        } else {
          // No subscription found - user is on free plan
          console.log('✅ No subscription found - user is on free plan');
          window.currentUserPlan = 'free';
        }
      } catch (error) {
        console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Error loading current plan:', error);
        // Set to free plan as fallback
        window.currentUserPlan = 'free';
      }
    }

    // Update pricing cards to show current plan
    function updatePricingDisplay(subscription) {
      // Set global variable for current plan
      window.currentUserPlan = (subscription.plan || 'Free').toLowerCase();
      window.currentSubscription = subscription;

      // Remove all current plan indicators and remaining time displays
      document.querySelectorAll('.pricing-card').forEach(card => {
        card.classList.remove('current-plan');
        const badge = card.querySelector('.current-plan-badge');
        if (badge) badge.remove();
        const timeRemaining = card.querySelector('.time-remaining');
        if (timeRemaining) timeRemaining.remove();
      });

      // Find and highlight the current plan
      const currentPlan = window.currentUserPlan;
      let cardSelector = '';

      if (currentPlan === 'free') {
        cardSelector = '.pricing-card:nth-child(1)'; // First card (Free)
      } else if (currentPlan === 'light') {
        cardSelector = '.pricing-card:nth-child(2)'; // Second card (Light)
      } else if (currentPlan === 'basic') {
        cardSelector = '.pricing-card:nth-child(3)'; // Third card (Basic)
      } else if (currentPlan === 'premium') {
        cardSelector = '.pricing-card:nth-child(4)'; // Fourth card (Premium)
      }

      if (cardSelector) {
        const currentCard = document.querySelector(cardSelector);
        if (currentCard) {
          currentCard.classList.add('current-plan');

          // Add current plan badge
          const badge = document.createElement('div');
          badge.className = 'current-plan-badge';

          // Check subscription status for badge text
          if (subscription.subscription_status === 'canceling' || subscription.cancel_at_period_end) {
            badge.textContent = 'Canceling at Period End';
            badge.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
          } else {
            badge.textContent = 'Current Plan';
          }

          currentCard.style.position = 'relative';
          currentCard.appendChild(badge);

          // Add remaining time display for paid plans
          if (currentPlan !== 'free') {
            // Prefer Stripe data if available, otherwise use Airtable data
            const endDateString = subscription.current_period_end || subscription.plan_end_date;

            if (endDateString) {
              const timeDiv = document.createElement('div');
              timeDiv.className = 'time-remaining';
              timeDiv.style.cssText = 'margin: 32px auto 0; max-width: 600px; padding: 20px 24px; background: rgba(213, 166, 117, 0.1); border: 1px solid rgba(213, 166, 117, 0.2); border-radius: 16px; font-size: 15px; color: #fff; text-align: center; backdrop-filter: blur(10px);';

              const endDate = new Date(endDateString);
              const now = new Date();
              const daysRemaining = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

              if (subscription.subscription_status === 'canceling' || subscription.cancel_at_period_end) {
                timeDiv.innerHTML = `<div style="font-weight: 600; margin-bottom: 4px;">Benefits active until ${endDate.toLocaleDateString()}</div><div style="font-size: 12px; opacity: 0.7;">Your subscription will end on this date and you'll be moved to the Free plan</div>`;
              } else {
                timeDiv.innerHTML = `<div style="font-weight: 600; margin-bottom: 4px;">Next billing: ${endDate.toLocaleDateString()}</div><div style="font-size: 12px; opacity: 0.7;">${daysRemaining} ${daysRemaining === 1 ? 'day' : 'days'} remaining in current period</div>`;
              }

              // Insert after the pricing grid instead of inside the card
              const pricingGrid = document.querySelector('.pricing-grid');
              if (pricingGrid) {
                pricingGrid.insertAdjacentElement('afterend', timeDiv);
              }
            }
          }

          // Update button text for current plan
          const button = currentCard.querySelector('.plan-button');
          if (button) {
            if (currentPlan === 'free') {
              button.textContent = 'Current Plan';
              button.style.opacity = '0.7';
              button.onclick = function() { return false; };
            } else if (subscription.subscription_status === 'canceling' || subscription.cancel_at_period_end) {
              button.textContent = 'Reactivate Subscription';
              button.onclick = function() {
                reactivateSubscription();
                return false;
              };
            } else {
              button.textContent = 'Manage Plan';
              button.onclick = function() {
                window.location.href = '/profile';
                return false;
              };
            }
          }
        }
      }

      // Update other plan buttons for upgrades/downgrades
      updatePlanButtons(currentPlan, subscription);
    }

    // Update plan button texts based on current subscription
    function updatePlanButtons(currentPlan, subscription) {
      // Only update subscription tab cards, not credit pack buttons
      const subscriptionTab = document.getElementById('subscriptions-tab');
      if (!subscriptionTab) return;

      const cards = subscriptionTab.querySelectorAll('.pricing-card');

      cards.forEach((card, index) => {
        const button = card.querySelector('.plan-button');
        if (!button || card.classList.contains('current-plan')) return;

        // Reset button onclick to default plan selection
        button.onclick = function() {
          const planTypes = ['free', 'light', 'basic', 'premium'];
          handlePlanClick(planTypes[index]);
          return false;
        };

        if (index === 0) { // Free
          if (currentPlan !== 'free') {
            button.textContent = 'Downgrade to Free';
          } else {
            button.textContent = 'Start Free';
          }
        } else if (index === 1) { // Light
          if (currentPlan === 'free') {
            button.textContent = 'Upgrade to Light';
          } else if (currentPlan === 'basic' || currentPlan === 'premium') {
            button.textContent = 'Downgrade to Light';
          } else {
            button.textContent = 'Choose Light';
          }
        } else if (index === 2) { // Basic
          if (currentPlan === 'free' || currentPlan === 'light') {
            button.textContent = 'Upgrade to Basic';
          } else if (currentPlan === 'premium') {
            button.textContent = 'Downgrade to Basic';
          } else {
            button.textContent = 'Choose Basic';
          }
        } else if (index === 3) { // Premium
          if (currentPlan === 'free' || currentPlan === 'light' || currentPlan === 'basic') {
            button.textContent = 'Upgrade to Premium';
          } else {
            button.textContent = 'Choose Premium';
          }
        }
      });
    }

    // Reactivate subscription
    async function reactivateSubscription() {
      try {
        const user = window.getCurrentUser();
        if (!user) {
          alert('Please log in to manage your subscription');
          return;
        }

        console.log('🔄 Reactivating subscription for user:', user.email);

        const response = await fetch('/.netlify/functions/selira-manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'reactivate',
            userEmail: user.email,
            auth0Id: user.sub
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          console.log('✅ Subscription reactivated successfully:', result);
          alert('Subscription reactivated successfully! Your plan will continue as normal.');

          // Reload the current plan display
          await loadCurrentPlan();
        } else {
          console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Reactivation failed:', result);
          alert(`Failed to reactivate subscription: ${result.error || 'Unknown error'}`);
        }

      } catch (error) {
        console.error('<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Error reactivating subscription:', error);
        alert('An error occurred while reactivating your subscription. Please try again.');
      }
    }

    // Initialize current plan loading when page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(loadCurrentPlan, 1000);

      // Check URL parameter for tab selection
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');

      if (tabParam === 'credits' || tabParam === 'oneoff') {
        switchTab('oneoff');
      } else if (tabParam === 'subscriptions') {
        switchTab('subscriptions');
      }
      // Default is already set to oneoff tab
    });

    // Handle credit purchase
    async function handleCreditPurchase(packageType) {
      console.log('💳 Credit purchase initiated:', packageType);

      // Check if user is logged in FIRST
      const isLoggedIn = localStorage.getItem('auth0_token') || localStorage.getItem('user_uid');

      if (!isLoggedIn) {
        // User is not logged in - show registration popup
        if (typeof openLoginModal === 'function') {
          openLoginModal('signup');
        } else {
          alert('Please sign up to purchase credits');
        }
        return;
      }

      // Track InitiateCheckout event AFTER authentication check
      const packageDetails = {
        'light': { credits: 50, value: 4.99 },
        'basic': { credits: 100, value: 9.99 },
        'premium': { credits: 250, value: 24.99 }
      };

      const details = packageDetails[packageType];
      if (details && window.seliraPixelTracking) {
        window.seliraPixelTracking.trackEvent('InitiateCheckout', {
          content_name: `${details.credits} Image Credits`,
          content_category: 'Image Credits',
          value: details.value,
          currency: 'USD',
          content_type: 'product'
        }, `checkout_credits_${packageType}_${Date.now()}`);
      }

      try {
        // Map package types to Stripe price IDs
        const priceIds = {
          'light': 'price_1SEvgFDEKVIZZyJVOpdIVcBG',
          'basic': 'price_1SEvglDEKVIZZyJVQvKtNhmD',
          'premium': 'price_1SEvhLDEKVIZZyJVvvjd7gSO'
        };

        const priceId = priceIds[packageType];
        if (!priceId) {
          console.error('Invalid package type:', packageType);
          alert('Invalid package selected');
          return;
        }

        // Get user info
        const userEmail = localStorage.getItem('user_email');
        const userId = localStorage.getItem('user_uid');

        if (!userEmail || !userId) {
          console.error('Missing user information');
          alert('Please log in again to continue');
          window.location.href = '/';
          return;
        }

        // Store credit purchase info for tracking
        localStorage.setItem('credits_purchased', JSON.stringify({
          credits: details.credits,
          amount: details.value,
          packageType: packageType
        }));

        // Create Stripe checkout session
        const response = await fetch('/.netlify/functions/selira-create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            priceId: priceId,
            userEmail: userEmail,
            userId: userId,
            mode: 'payment', // One-time payment
            successUrl: window.location.origin + `/profile?purchase=credits&credits=${details.credits}&amount=${details.value}`,
            cancelUrl: window.location.origin + '/pricing?tab=oneoff'
          })
        });

        if (!response.ok) {
          const error = await response.json();
          console.error('Checkout session error:', error);
          alert('Unable to start checkout process. Please try again.');
          return;
        }

        const { sessionUrl } = await response.json();

        if (sessionUrl) {
          // Redirect to Stripe checkout
          window.location.href = sessionUrl;
        } else {
          console.error('No session URL received');
          alert('Unable to start checkout process. Please try again.');
        }

      } catch (error) {
        console.error('Error initiating credit purchase:', error);
        alert('An error occurred. Please try again later.');
      }
    }
  </script>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav">
    <div class="mobile-bottom-nav-container">
      <a href="/" class="mobile-nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Discover</span>
      </a>
      <a href="/my-companions" class="mobile-nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Chat</span>
      </a>
      <a href="/create" class="mobile-nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Create</span>
      </a>
      <a href="/free-nsfw-image-generator" class="mobile-nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <span>Image</span>
      </a>
      <a href="/pricing" class="mobile-nav-item active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        <span>Pricing</span>
      </a>
    </div>
  </nav>

  <!-- Email Verification Handler -->
  <script src="js/email-verification-handler.js"></script>
  <script src="js/unverified-email-banner.js"></script>
</body>
</html>